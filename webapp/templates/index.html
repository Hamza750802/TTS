{% extends 'base.html' %}
{% block title %}Cheap TTS ‚Äî Text to Speech Dashboard{% endblock %}
{% block head %}
<style>
  .dashboard-hero {
    background: linear-gradient(180deg, #FFFBF7 0%, #FFF0EB 50%, #FFE8E0 100%);
    padding: 50px 0 40px 0;
    text-align: center;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
  }
  .dashboard-hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255,170,133,0.12) 0%, transparent 70%);
    border-radius: 50%;
  }
  .dashboard-hero::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -10%;
    width: 350px;
    height: 350px;
    background: radial-gradient(circle, rgba(125,211,192,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }

  .dashboard-hero h1 {
    font-size: 38px;
    font-weight: 700;
    margin-bottom: 12px;
    background: linear-gradient(135deg, #FF9A8B 0%, #FF6B95 50%, #FF8E53 100%);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    z-index: 1;
  }

  .dashboard-hero p {
    font-size: 17px;
    color: #636E72;
    position: relative;
    z-index: 1;
  }

  .tts-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 48px 24px;
  }

  .form-card {
    background: white;
    padding: 40px;
    border-radius: 24px;
    border: 1px solid rgba(0,0,0,0.05);
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.06);
  }

  .form-section {
    margin-bottom: 32px;
  }

  .form-section:last-of-type {
    margin-bottom: 0;
  }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #2D3436;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: linear-gradient(180deg, #FF9A8B, #FF8E53);
    border-radius: 2px;
  }

  .input-group {
    margin-bottom: 20px;
  }

  .input-group:last-child {
    margin-bottom: 0;
  }

  label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #2D3436;
    margin-bottom: 8px;
  }

  textarea,
  select {
    width: 100%;
    padding: 14px 16px;
    border-radius: 14px;
    border: 2px solid rgba(0,0,0,0.06);
    background: #FFFBF7;
    color: #2D3436;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
  }

  textarea:focus,
  select:focus {
    outline: none;
    border-color: #FF7B72;
    background: white;
    box-shadow: 0 0 0 4px rgba(255,123,114,0.1);
  }

  textarea {
    min-height: 160px;
    resize: vertical;
    font-family: ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    line-height: 1.6;
  }

  select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23636E72' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }

  select option {
    background: white;
    color: #2D3436;
    padding: 8px;
  }

  .controls-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }

  @media (min-width: 768px) {
    .controls-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .slider-group {
    background: #FFFBF7;
    padding: 16px;
    border-radius: 14px;
    border: 1px solid rgba(0,0,0,0.05);
  }

  .slider-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 14px;
    font-weight: 600;
    color: #2D3436;
  }

  .slider-value {
    color: #FF7B72;
    font-weight: 700;
  }

  input[type="range"] {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: rgba(0,0,0,0.08);
    outline: none;
    -webkit-appearance: none;
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FF9A8B, #FF8E53);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(255,123,114,0.4);
  }

  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #FF9A8B, #FF8E53);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(255,123,114,0.4);
  }

  .generate-btn {
    width: 100%;
    padding: 18px 24px;
    border-radius: 16px;
    border: none;
    cursor: pointer;
    color: white;
    font-weight: 700;
    font-size: 17px;
    background: linear-gradient(135deg, #FF9A8B 0%, #FF6B95 50%, #FF8E53 100%);
    box-shadow: 0 8px 32px rgba(255,123,114,0.3);
    transition: all 0.3s;
    margin-top: 32px;
  }

  .generate-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(255,123,114,0.4);
  }

  .generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .loading {
    display: none;
    text-align: center;
    padding: 24px;
    margin-top: 24px;
    background: rgba(126,200,227,0.1);
    border-radius: 14px;
    border: 1px solid rgba(126,200,227,0.2);
  }

  .loading.visible {
    display: block;
  }

  .loading p {
    color: #7EC8E3;
    font-weight: 600;
    margin: 0;
  }

  .error {
    display: none;
    background: rgba(255,123,114,0.1);
    border: 1px solid rgba(255,123,114,0.2);
    padding: 16px;
    border-radius: 14px;
    margin-top: 24px;
    color: #FF7B72;
    font-weight: 500;
  }

  .error.visible {
    display: block;
  }

  .audio-player {
    margin-top: 32px;
    padding: 32px;
    border: 2px solid rgba(0,0,0,0.06);
    border-radius: 20px;
    background: linear-gradient(135deg, #FFFBF7 0%, #FFFFFF 100%);
  }

  .audio-player strong {
    display: block;
    font-size: 18px;
    color: #2D3436;
    margin-bottom: 16px;
  }

  .audio-player audio {
    width: 100%;
    margin-bottom: 16px;
    border-radius: 8px;
  }

  .download-btn {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 12px;
    border: 2px solid #FF7B72;
    background: white;
    color: #FF7B72;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }

  .download-btn:hover {
    background: linear-gradient(135deg, #FF9A8B, #FF8E53);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(255,123,114,0.25);
  }

  .toggle-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
  }

  .toggle-row label {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    margin: 0;
  }

  .timeline-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }

  .timeline-actions button {
    padding: 12px 20px;
    background: linear-gradient(135deg, #6BCB77, #4ade80);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(107,203,119,0.25);
  }

  .timeline-actions button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(107,203,119,0.35);
  }

  .timeline-actions button.secondary {
    background: linear-gradient(135deg, #FF7B72, #f87171);
  }

  .timeline-actions button.secondary:hover {
    box-shadow: 0 8px 24px rgba(255,123,114,0.35);
  }

  .chunk-card {
    border: 1px solid rgba(255,123,114,0.15);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 14px;
    background: linear-gradient(135deg, rgba(255,251,247,0.8), rgba(255,255,255,0.9));
    box-shadow: 0 4px 16px rgba(45,52,54,0.05);
    transition: all 0.3s ease;
  }

  .chunk-card:hover {
    box-shadow: 0 8px 24px rgba(45,52,54,0.08);
  }

  .chunk-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-weight: 700;
    color: #2D3436;
  }

  .chunk-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 10px;
    align-items: end;
  }

  .chunk-content {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(126,200,227,0.3);
    padding: 12px;
    background: white;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .chunk-content:focus {
    border-color: #FF7B72;
    outline: none;
    box-shadow: 0 0 0 3px rgba(255,123,114,0.1);
  }

  .chunk-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  .chunk-actions button {
    border: 1px solid rgba(126,200,227,0.4);
    background: white;
    border-radius: 10px;
    padding: 8px 14px;
    cursor: pointer;
    font-weight: 600;
    color: #2D3436;
    transition: all 0.3s ease;
  }

  .chunk-actions button:hover {
    background: linear-gradient(135deg, rgba(126,200,227,0.15), rgba(107,203,119,0.1));
    border-color: #7EC8E3;
    transform: translateY(-1px);
  }

  .ssml-preview {
    width: 100%;
    min-height: 140px;
    border-radius: 14px;
    border: 1px solid rgba(126,200,227,0.3);
    background: linear-gradient(135deg, #FFFBF7, #fff);
    padding: 14px;
    font-family: ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 13px;
    color: #2D3436;
  }

  .cta {
    display: grid;
    gap: 20px;
    text-align: center;
    max-width: 600px;
    margin: 80px auto;
    padding: 48px 32px;
    background: linear-gradient(145deg, rgba(255,255,255,0.95), rgba(255,251,247,0.9));
    border-radius: 24px;
    border: 1px solid rgba(255,123,114,0.15);
    box-shadow: 0 20px 60px rgba(45,52,54,0.08);
  }

  .cta h3 {
    margin: 0;
    font-size: 32px;
    font-weight: 900;
    color: #2D3436;
    background: linear-gradient(135deg, #2D3436, #636E72);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .cta p {
    margin: 0;
    color: #636E72;
    font-size: 18px;
  }

  .cta .actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 12px;
    flex-wrap: wrap;
  }
</style>
{% endblock %}

{% block content %}
{% if not current_user.is_authenticated %}
<div class="cta">
  <h3>Sign in to start creating audio</h3>
  <p>Create an account to get started with 10,000 free characters per month</p>
  <div class="actions">
    <a class="btn" href="{{ url_for('login') }}">Sign in</a>
    <a class="btn primary" href="{{ url_for('signup') }}">Sign up Free</a>
  </div>
</div>
{% else %}
<div class="dashboard-hero">
  <div class="container">
    <h1>Text-to-Speech Studio</h1>
    <p>Transform your text into natural-sounding speech</p>
  </div>
</div>

<!-- Character Usage Card -->
<div style="max-width: 900px; margin: 0 auto; padding: 20px 24px 0 24px;">
  <div id="usageCard" style="background: white; border-radius: 16px; padding: 20px 24px; border: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 16px rgba(0,0,0,0.04); margin-bottom: 0;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div style="display: flex; align-items: center; gap: 8px;">
        <span id="usageIcon" style="font-size: 18px;">üìà</span>
        <span style="font-weight: 600; color: #2D3436;">Monthly Usage</span>
        {% if not is_unlimited %}
        <span style="background: linear-gradient(135deg, rgba(255,154,139,0.15), rgba(255,142,83,0.15)); color: #FF7B72; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 8px;">FREE PLAN</span>
        {% else %}
        <span style="background: linear-gradient(135deg, #7DD3C0, #7EC8E3); color: white; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 8px;">UNLIMITED</span>
        {% endif %}
      </div>
      <span id="usageText" style="font-weight: 700; color: #636E72;" data-unlimited="{{ 'true' if is_unlimited else 'false' }}">
        {% if is_unlimited %}
          ‚àû Unlimited
        {% else %}
          {{ chars_used|int }} / {{ chars_limit|int }} characters
        {% endif %}
      </span>
    </div>
    {% if not is_unlimited %}
    <div style="background: #f1f5f9; border-radius: 8px; height: 10px; overflow: hidden;">
      <div id="usageBar" style="height: 100%; border-radius: 8px; transition: width 0.3s, background 0.3s;
        width: {{ ((chars_used / chars_limit) * 100)|round(1) if chars_limit > 0 else 0 }}%;
        background: {% if (chars_used / chars_limit) >= 1 %}#ef4444{% elif (chars_used / chars_limit) >= 0.8 %}#f97316{% else %}linear-gradient(135deg, #FF9A8B, #FF8E53){% endif %};
      "></div>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; flex-wrap: wrap; gap: 10px;">
      <span id="remainingText" style="font-size: 13px; color: #636E72;">
        {{ chars_remaining|int }} characters remaining ‚Ä¢ Resets {{ chars_reset_date }}
      </span>
      <a href="{{ url_for('subscribe') }}" id="upgradeBtn" style="
        display: inline-flex; align-items: center; gap: 6px;
        padding: 10px 18px; border-radius: 12px;
        background: {% if (chars_used / chars_limit) >= 1 %}linear-gradient(135deg, #ef4444, #dc2626){% elif (chars_used / chars_limit) >= 0.8 %}linear-gradient(135deg, #f97316, #ea580c){% else %}linear-gradient(135deg, #FF9A8B, #FF8E53){% endif %};
        color: white; font-size: 13px; font-weight: 600;
        text-decoration: none; transition: all 0.2s;
        box-shadow: 0 4px 12px {% if (chars_used / chars_limit) >= 1 %}rgba(239,68,68,0.3){% elif (chars_used / chars_limit) >= 0.8 %}rgba(249,115,22,0.3){% else %}rgba(255,123,114,0.2){% endif %};
      ">
        {% if (chars_used / chars_limit) >= 1 %}
        üöÄ Upgrade for Unlimited - $7.99/mo
        {% elif (chars_used / chars_limit) >= 0.8 %}
        ‚ö° Running Low! Upgrade Now
        {% else %}
        ‚ú® Go Unlimited - $7.99/mo
        {% endif %}
      </a>
    </div>
    {% else %}
    <div style="font-size: 13px; color: #10b981; margin-top: 4px;">
      ‚ú® You have unlimited characters with your subscription
    </div>
    {% endif %}
  </div>
  
  {% if not is_unlimited and (chars_used / chars_limit) >= 0.5 %}
  <!-- Plan Comparison Popup - shown when usage is 50%+ -->
  <div id="planCompare" style="position: relative; background: linear-gradient(135deg, #FFFBF7, #FFF0EB); border-radius: 16px; padding: 20px 24px; border: 1px solid rgba(255,123,114,0.2); margin-top: 12px; display: {% if (chars_used / chars_limit) >= 0.8 %}block{% else %}none{% endif %};">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 24px; flex-wrap: wrap;">
      <div style="flex: 1; min-width: 200px;">
        <div style="font-weight: 700; color: #2D3436; margin-bottom: 8px;">Free Plan</div>
        <ul style="font-size: 13px; color: #636E72; margin: 0; padding-left: 18px; line-height: 1.8;">
          <li>10,000 characters/month</li>
          <li>All 550+ voices</li>
          <li>All features included</li>
        </ul>
      </div>
      <div style="width: 1px; background: rgba(0,0,0,0.1); align-self: stretch; display: none;" class="plan-divider"></div>
      <div style="flex: 1; min-width: 200px;">
        <div style="font-weight: 700; color: #FF7B72; margin-bottom: 8px;">‚ú® Unlimited Plan</div>
        <ul style="font-size: 13px; color: #636E72; margin: 0; padding-left: 18px; line-height: 1.8;">
          <li><strong style="color: #2D3436;">Unlimited</strong> characters</li>
          <li>Priority generation</li>
          <li>Commercial rights</li>
        </ul>
      </div>
      <div style="flex: 1; min-width: 150px; text-align: center;">
        <div style="font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #FF9A8B, #FF8E53); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">$7.99<small style="font-size: 14px; font-weight: 500;">/mo</small></div>
        <div style="font-size: 12px; color: #7DD3C0; margin: 4px 0;">or $99 lifetime</div>
        <a href="{{ url_for('subscribe') }}" style="display: inline-block; padding: 10px 20px; background: linear-gradient(135deg, #FF9A8B, #FF8E53); color: white; border-radius: 10px; font-size: 13px; font-weight: 600; text-decoration: none; margin-top: 8px; transition: all 0.2s; box-shadow: 0 4px 12px rgba(255,123,114,0.3);">Upgrade Now</a>
      </div>
    </div>
    <button onclick="this.parentElement.style.display='none'" style="position: absolute; top: 10px; right: 14px; background: none; border: none; font-size: 18px; cursor: pointer; color: #B2BEC3; line-height: 1;">&times;</button>
  </div>
  {% endif %}
</div>

<!-- Premium Ultra-Realistic Voices Coming Soon Banner -->
<div style="max-width: 900px; margin: 16px auto 0; padding: 0 24px;">
  <div style="
    position: relative;
    background: linear-gradient(135deg, #1e1b4b, #312e81, #3730a3);
    border-radius: 20px;
    padding: 24px 28px;
    overflow: hidden;
    border: 1px solid rgba(147,51,234,0.3);
    box-shadow: 0 8px 32px rgba(147,51,234,0.15);
  ">
    <!-- Glow effect -->
    <div style="position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(236,72,153,0.25), transparent 70%); pointer-events: none;"></div>
    <div style="position: absolute; bottom: -30px; left: -30px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(147,51,234,0.3), transparent 70%); pointer-events: none;"></div>
    
    <div style="position: relative; z-index: 1; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 20px;">
      <div style="flex: 1; min-width: 280px;">
        <div style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #9333ea, #ec4899); color: white; font-size: 10px; font-weight: 700; letter-spacing: 1.2px; padding: 5px 12px; border-radius: 50px; margin-bottom: 12px; animation: pulse-badge 2s infinite;">
          üöÄ COMING SOON
        </div>
        <h3 style="color: white; font-size: 22px; font-weight: 700; margin: 0 0 8px 0; background: linear-gradient(135deg, #fff, #e0e7ff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">Premium Ultra-Realistic Voices</h3>
        <p style="color: rgba(255,255,255,0.8); font-size: 13px; margin: 0; line-height: 1.5;">The most human-like AI voices ever ‚Äî <span style="color: #a78bfa; font-weight: 600;">more natural than ElevenLabs</span></p>
      </div>
      <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; align-items: center;">
        <span style="display: flex; align-items: center; gap: 6px; color: rgba(255,255,255,0.9); font-size: 12px;">
          <span style="color: #22c55e;">‚úì</span> Real human breathing
        </span>
        <span style="display: flex; align-items: center; gap: 6px; color: rgba(255,255,255,0.9); font-size: 12px;">
          <span style="color: #22c55e;">‚úì</span> Emotional depth
        </span>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes pulse-badge {
    0%, 100% { box-shadow: 0 0 12px rgba(147,51,234,0.5); }
    50% { box-shadow: 0 0 24px rgba(236,72,153,0.6); }
  }
  
  /* Tab Styles */
  .tts-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
  }
  .tts-tab {
    flex: 1;
    padding: 16px 24px;
    border-radius: 16px 16px 0 0;
    border: 2px solid rgba(0,0,0,0.06);
    border-bottom: none;
    background: #f8f9fa;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: #636E72;
    text-align: center;
  }
  .tts-tab:hover {
    background: #FFF0EB;
  }
  .tts-tab.active {
    background: white;
    color: #2D3436;
    border-color: rgba(255,123,114,0.3);
    position: relative;
  }
  .tts-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 4px;
    background: white;
  }
  .tts-tab.premium-tab {
    background: linear-gradient(135deg, rgba(147,51,234,0.1), rgba(236,72,153,0.1));
    border-color: rgba(147,51,234,0.2);
  }
  .tts-tab.premium-tab:hover {
    background: linear-gradient(135deg, rgba(147,51,234,0.15), rgba(236,72,153,0.15));
  }
  .tts-tab.premium-tab.active {
    background: linear-gradient(135deg, rgba(147,51,234,0.1), rgba(236,72,153,0.1));
    border-color: rgba(147,51,234,0.4);
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .premium-badge-small {
    background: linear-gradient(135deg, #9333ea, #ec4899);
    color: white;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 6px;
    margin-left: 6px;
    font-weight: 700;
  }
</style>

<div class="tts-container">
  <!-- TTS Tabs -->
  <div class="tts-tabs">
    <button type="button" class="tts-tab active" onclick="switchTab('standard')" id="tabStandard">
      üéôÔ∏è Pro Voices <span style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white; font-size: 9px; padding: 2px 6px; border-radius: 6px; margin-left: 6px; font-weight: 700;">550+</span>
      <div style="font-size: 11px; color: #636E72; font-weight: 400; margin-top: 4px;">Realistic emotions ‚Ä¢ Fast & reliable</div>
    </button>
    <button type="button" class="tts-tab premium-tab" onclick="switchTab('premium')" id="tabPremium">
      ‚ú® Ultra Voices <span class="premium-badge-small">PREMIUM</span>
      <div style="font-size: 11px; color: #9333ea; font-weight: 400; margin-top: 4px;">Ultra-realistic emotions & expressions</div>
    </button>
  </div>

  <!-- Standard TTS Tab Content -->
  <div class="tab-content active" id="standardTab">
    <form id="ttsForm">
      <div class="form-card">
      <!-- Text Input Section -->
      <div class="form-section">
        <div class="section-title">Your Text</div>
        <div class="input-group">
          <label for="text">Enter the text you want to convert to speech</label>
          <textarea id="text" placeholder="Type or paste your text here..." required></textarea>
        </div>
      </div>

      <!-- Voice Selection Section -->
      <div class="form-section">
        <div class="section-title">Voice Settings</div>
        <div class="input-group">
          <label for="voice">Choose Voice</label>
          
          <!-- Voice Filters -->
          <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;">
            <div style="display: flex; gap: 6px;">
              <button type="button" id="filterAll" class="voice-filter-btn active" onclick="filterVoices('all')">All Voices</button>
              <button type="button" id="filterEmotions" class="voice-filter-btn" onclick="filterVoices('emotions')">üé≠ With Emotions <span id="emotionCount" style="background: #FF7B72; color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; margin-left: 4px;">47</span></button>
            </div>
            <select id="languageFilter" onchange="filterVoices(currentVoiceFilter)" style="padding: 8px 12px; border-radius: 10px; border: 2px solid rgba(0,0,0,0.06); background: #FFFBF7; font-size: 13px; cursor: pointer;">
              <option value="all">üåç All Languages</option>
              <option value="en">üá∫üá∏ English</option>
              <option value="es">üá™üá∏ Spanish</option>
              <option value="fr">üá´üá∑ French</option>
              <option value="de">üá©üá™ German</option>
              <option value="it">üáÆüáπ Italian</option>
              <option value="pt">üáµüáπ Portuguese</option>
              <option value="zh">üá®üá≥ Chinese</option>
              <option value="ja">üáØüáµ Japanese</option>
              <option value="ko">üá∞üá∑ Korean</option>
              <option value="ar">üá∏üá¶ Arabic</option>
              <option value="hi">üáÆüá≥ Hindi</option>
              <option value="other">Other Languages</option>
            </select>
          </div>
          
          <style>
            .voice-filter-btn {
              padding: 8px 14px;
              border-radius: 10px;
              border: 2px solid rgba(0,0,0,0.06);
              background: #FFFBF7;
              font-size: 13px;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              color: #636E72;
            }
            .voice-filter-btn:hover {
              border-color: #FF7B72;
              background: #FFF0EB;
            }
            .voice-filter-btn.active {
              background: linear-gradient(135deg, #FF9A8B, #FF8E53);
              color: white;
              border-color: transparent;
              box-shadow: 0 4px 12px rgba(255,123,114,0.25);
            }
          </style>
          
          <select id="voice" required>
            <option value="">Loading voices...</option>
          </select>
          <p id="voiceCount" style="font-size: 12px; color: #636E72; margin-top: 6px;">Loading voices...</p>
        </div>
        <div class="input-group">
          <label for="preset">Hero Presets</label>
          <select id="preset">
            <option value="">No preset (manual)</option>
          </select>
          <p id="presetDesc" style="font-size: 13px; color: #636E72; margin-top: 6px;"></p>
        </div>
        <div class="input-group" id="styleGroup" style="display: none;">
          <label for="style">Style (Emotion) üé≠</label>
          <select id="style">
            <option value="">Default (no style)</option>
          </select>
        </div>
      </div>

      <!-- Automation Toggles -->
      <div class="form-section">
        <div class="section-title">Automation</div>
        <div class="toggle-row">
          <label><input type="checkbox" id="autoPauses" checked /> Auto pauses</label>
          <label><input type="checkbox" id="autoEmphasis" checked /> Auto emphasis</label>
          <label><input type="checkbox" id="autoBreaths" /> Auto breaths</label>
          <label><input type="checkbox" id="generateSrt" disabled /> üìù Generate SRT subtitles <span style="background: #fef3c7; color: #d97706; font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px;">COMING SOON</span></label>
        </div>
      </div>

      <!-- Emotional Timeline -->
      <div class="form-section">
        <div class="section-title">üéôÔ∏è Multi-Speaker Dialogue</div>
        <div
          style="background: linear-gradient(135deg, rgba(107,203,119,0.1), rgba(126,200,227,0.1)); border: 1px solid rgba(107,203,119,0.3); padding: 14px; border-radius: 12px; margin-bottom: 14px;">
          <strong style="color: #6BCB77;">üí° Pro Tip: Use Dialogue Markup!</strong>
          <p style="color: #2D3436; font-size: 13px; margin: 6px 0 0 0;">
            Format: <code style="background: rgba(107,203,119,0.15); padding: 2px 8px; border-radius: 6px; color: #2D3436;">[SpeakerA]: Hello!</code> or
            <code style="background: rgba(107,203,119,0.15); padding: 2px 8px; border-radius: 6px; color: #2D3436;">[SpeakerA:cheerful]: Hello!</code>
          </p>
          <p style="color: #E17055; font-size: 13px; margin: 8px 0 0 0; font-weight: 600;">
            ‚ö†Ô∏è Important: Text must be on the <u>same line</u> as the speaker tag. After entering your dialogue, click <strong>"Split Text into Chunks"</strong> below.
          </p>
        </div>
        <p style="color:#636E72; font-size:14px; margin-bottom:10px;">Split your text to assign different voices &
          emotions to each part</p>
        <div class="timeline-actions">
          <button type="button" id="btnSplit">‚úÇÔ∏è Split Text into Chunks</button>
          <button type="button" class="secondary" id="btnReset" style="display: none;">üóëÔ∏è Clear Chunks</button>
        </div>
        <div id="chunkList"></div>
      </div>

      <!-- Audio Adjustments Section -->
      <div class="form-section" style="display: none;">
        <div class="section-title">Audio Adjustments</div>
        <div class="controls-grid">
          <div class="slider-group">
            <div class="slider-label">
              <span>Speed</span>
              <span class="slider-value" id="rateValue">Normal</span>
            </div>
            <input type="range" id="rate" min="-50" max="50" value="0" step="5" />
          </div>
          <div class="slider-group">
            <div class="slider-label">
              <span>Volume</span>
              <span class="slider-value" id="volumeValue">Normal</span>
            </div>
            <input type="range" id="volume" min="-50" max="50" value="0" step="5" />
          </div>
          <div class="slider-group">
            <div class="slider-label">
              <span>Pitch</span>
              <span class="slider-value" id="pitchValue">Normal</span>
            </div>
            <input type="range" id="pitch" min="-50" max="50" value="0" step="5" />
          </div>
        </div>
      </div>

      <button type="submit" class="generate-btn" id="generateBtn">üéôÔ∏è Generate Speech</button>
    </div>

    <div class="loading" id="loading">
      <p>‚è≥ Generating your speech...</p>
    </div>
    <div class="error" id="error"></div>
    <div class="audio-player" id="audioPlayer" style="display:none">
      <strong>‚ú® Your audio is ready!</strong>
      <audio id="audioElement" controls></audio>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a id="downloadLink" class="download-btn" download="speech.mp3">‚¨áÔ∏è Download MP3</a>
        <a id="downloadSrtLink" class="download-btn" download="speech.srt" style="display: none; background: linear-gradient(135deg, #7DD3C0, #7EC8E3);">üìù Download SRT</a>
      </div>
    </div>
  </form>
  </div><!-- End Standard Tab -->

  <!-- Premium TTS Tab Content -->
  <div class="tab-content" id="premiumTab">
    <form id="premiumTtsForm">
      <div class="form-card">
        <!-- Premium Header -->
        <div style="background: linear-gradient(135deg, rgba(147,51,234,0.1), rgba(236,72,153,0.1)); border: 2px solid rgba(147,51,234,0.2); border-radius: 16px; padding: 20px; margin-bottom: 24px; text-align: center;">
          <h3 style="margin: 0 0 8px 0; background: linear-gradient(135deg, #9333ea, #ec4899); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-size: 20px;">‚ú® Chatterbox Ultra Voices</h3>
          <p style="margin: 0; color: #636E72; font-size: 14px;">28 ultra-realistic AI voices with natural expression control</p>
        </div>

        {% if current_user.has_premium %}
        <!-- Premium User - Can use -->
        <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 12px 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
          <span style="color: #22c55e; font-weight: 600;">‚úì Premium Active</span>
          <span style="color: #636E72; font-size: 13px;">
            <span id="premiumCharsUsed">{{ current_user.premium_chars_used or 0 }}</span> / 
            <span id="premiumCharsLimit">{{ current_user.premium_char_limit }}</span> chars used
          </span>
        </div>
        {% else %}
        <!-- Non-Premium User - Upgrade prompt -->
        <div style="background: linear-gradient(135deg, rgba(147,51,234,0.1), rgba(236,72,153,0.1)); border: 2px solid rgba(147,51,234,0.3); border-radius: 16px; padding: 24px; margin-bottom: 24px; text-align: center;">
          <h4 style="margin: 0 0 12px 0; color: #9333ea;">üîí Premium Subscription Required</h4>
          <p style="color: #636E72; margin: 0 0 16px 0; font-size: 14px;">Upgrade to access Chatterbox ultra-realistic AI voices with natural expression.</p>
          <a href="/subscribe" style="display: inline-block; padding: 12px 32px; background: linear-gradient(135deg, #9333ea, #ec4899); color: white; text-decoration: none; border-radius: 12px; font-weight: 600; box-shadow: 0 4px 16px rgba(147,51,234,0.3);">Upgrade to Premium ‚Üí</a>
        </div>
        {% endif %}

        <!-- Voice Selection -->
        <div class="form-section">
          <div class="section-title">Voice Selection</div>
          <div class="input-group">
            <label for="premiumVoice">Choose a voice</label>
            <select id="premiumVoice" {% if not current_user.has_premium %}disabled{% endif %} style="width: 100%; padding: 12px 16px; border: 2px solid #DFE6E9; border-radius: 12px; font-size: 15px; background: white; cursor: pointer; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              <optgroup label="üë© Female Voices">
                <option value="Emily.wav" selected>Emily</option>
                <option value="Olivia.wav">Olivia</option>
                <option value="Taylor.wav">Taylor</option>
                <option value="Abigail.wav">Abigail</option>
                <option value="Alice.wav">Alice</option>
                <option value="Cora.wav">Cora</option>
                <option value="Elena.wav">Elena</option>
                <option value="Gianna.wav">Gianna</option>
                <option value="Jade.wav">Jade</option>
                <option value="Layla.wav">Layla</option>
              </optgroup>
              <optgroup label="üë® Male Voices">
                <option value="Michael.wav">Michael</option>
                <option value="Ryan.wav">Ryan</option>
                <option value="Thomas.wav">Thomas</option>
                <option value="Adrian.wav">Adrian</option>
                <option value="Alexander.wav">Alexander</option>
                <option value="Austin.wav">Austin</option>
                <option value="Axel.wav">Axel</option>
                <option value="Connor.wav">Connor</option>
                <option value="Eli.wav">Eli</option>
                <option value="Everett.wav">Everett</option>
                <option value="Gabriel.wav">Gabriel</option>
                <option value="Henry.wav">Henry</option>
                <option value="Ian.wav">Ian</option>
                <option value="Jeremiah.wav">Jeremiah</option>
                <option value="Jordan.wav">Jordan</option>
                <option value="Julian.wav">Julian</option>
                <option value="Leonardo.wav">Leonardo</option>
                <option value="Miles.wav">Miles</option>
              </optgroup>
            </select>
            <p style="font-size: 12px; color: #636E72; margin-top: 8px;">For multi-speaker dialogue, this voice is ignored and auto-assigned voices are used.</p>
          </div>
        </div>

        <!-- Text Input -->
        <div class="form-section">
          <div class="section-title">Your Text</div>
          <div class="input-group">
            <label for="premiumText">Enter text to convert</label>
            <textarea id="premiumText" placeholder="Type your text here...&#10;&#10;For multi-speaker dialogue, use voice names:&#10;[Emily]: Hello! How are you today?&#10;[Michael]: I'm doing great, thanks!&#10;[Emily]: That's wonderful to hear.&#10;&#10;Available voices: Emily, Michael, Olivia, Ryan, Taylor, Thomas, Jade, Alexander, and more!" {% if not current_user.has_premium %}disabled{% endif %} style="{% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}"></textarea>
            <p style="font-size: 12px; color: #9333ea; margin-top: 8px;">üí° Use [Emily]: [Michael]: etc. for multi-speaker dialogue. Click "Split into Chunks" to customize each segment!</p>
          </div>
          
          <!-- Split into Chunks Button -->
          <div style="margin-top: 12px; display: flex; gap: 10px; align-items: center;">
            <button type="button" id="splitChunksBtn" onclick="splitIntoChunks()" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 10px 20px; border-radius: 12px; border: 2px solid #9333ea; background: transparent; color: #9333ea; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              ‚úÇÔ∏è Split into Chunks
            </button>
            <button type="button" id="clearChunksBtn" onclick="clearChunks()" style="display: none; padding: 10px 16px; border-radius: 12px; border: 2px solid #e74c3c; background: transparent; color: #e74c3c; font-size: 13px; font-weight: 500; cursor: pointer;">
              ‚úï Back to Text
            </button>
            <span id="chunkModeIndicator" style="display: none; font-size: 12px; color: #9333ea; font-weight: 500;">üé≠ Per-chunk mode active</span>
          </div>
          
          <!-- Chunk Editor Container (hidden by default) -->
          <div id="premiumChunkEditor" style="display: none; margin-top: 20px;">
            <div style="background: linear-gradient(135deg, rgba(147,51,234,0.1), rgba(236,72,153,0.1)); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
              <p style="font-size: 13px; color: #2D3436; margin: 0;">üé≠ <strong>Per-Chunk Settings:</strong> Each chunk can have its own Chatterbox preset and slider adjustments.</p>
            </div>
            <div id="premiumChunkList" style="display: flex; flex-direction: column; gap: 16px;"></div>
          </div>
        </div>

        <!-- Style Presets -->
        <div class="form-section">
          <div class="section-title">Load Example Preset</div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
            <button type="button" class="preset-btn active" data-preset="standard" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 8px 16px; border-radius: 20px; border: 2px solid #9333ea; background: linear-gradient(135deg, #9333ea, #ec4899); color: white; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              üéôÔ∏è Standard Narration
            </button>
            <button type="button" class="preset-btn" data-preset="expressive" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 8px 16px; border-radius: 20px; border: 2px solid #9333ea; background: transparent; color: #9333ea; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              üé≠ Expressive Monologue
            </button>
            <button type="button" class="preset-btn" data-preset="technical" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 8px 16px; border-radius: 20px; border: 2px solid #9333ea; background: transparent; color: #9333ea; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              üìö Technical Explanation
            </button>
            <button type="button" class="preset-btn" data-preset="upbeat" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 8px 16px; border-radius: 20px; border: 2px solid #9333ea; background: transparent; color: #9333ea; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              üì¢ Upbeat Advertisement
            </button>
            <button type="button" class="preset-btn" data-preset="thoughtful" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 8px 16px; border-radius: 20px; border: 2px solid #9333ea; background: transparent; color: #9333ea; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              üí≠ Thoughtful Reflection
            </button>
            <button type="button" class="preset-btn" data-preset="punctuation" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 8px 16px; border-radius: 20px; border: 2px solid #9333ea; background: transparent; color: #9333ea; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              ‚úèÔ∏è Simple Punctuation
            </button>
            <button type="button" class="preset-btn" data-preset="longstory" {% if not current_user.has_premium %}disabled{% endif %} style="padding: 8px 16px; border-radius: 20px; border: 2px solid #9333ea; background: transparent; color: #9333ea; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; {% if not current_user.has_premium %}opacity: 0.5; cursor: not-allowed;{% endif %}">
              üìñ Long Story Excerpt
            </button>
          </div>
        </div>

        <!-- Generation Parameters (collapsible) -->
        <div class="form-section">
          <div class="section-title" style="cursor: pointer; display: flex; align-items: center; gap: 8px;" onclick="document.getElementById('generationParams').style.display = document.getElementById('generationParams').style.display === 'none' ? 'block' : 'none'; this.querySelector('.arrow').textContent = document.getElementById('generationParams').style.display === 'none' ? '‚ñ∂' : '‚ñº';">
            Generation Parameters <span class="arrow">‚ñº</span>
          </div>
          <div id="generationParams" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
              <!-- Temperature -->
              <div class="input-group">
                <label style="font-size: 13px; color: #2D3436;">Temperature (<span id="premiumTemperatureValue">0.8</span>)</label>
                <input type="range" id="premiumTemperature" min="0.1" max="1.5" step="0.05" value="0.8" {% if not current_user.has_premium %}disabled{% endif %} style="width: 100%; {% if not current_user.has_premium %}opacity: 0.5;{% endif %}">
              </div>
              <!-- Exaggeration -->
              <div class="input-group">
                <label style="font-size: 13px; color: #2D3436;">Exaggeration (<span id="premiumExaggerationValue">0.4</span>)</label>
                <input type="range" id="premiumExaggeration" min="0" max="2" step="0.1" value="0.4" {% if not current_user.has_premium %}disabled{% endif %} style="width: 100%; {% if not current_user.has_premium %}opacity: 0.5;{% endif %}">
              </div>
              <!-- CFG Weight -->
              <div class="input-group">
                <label style="font-size: 13px; color: #2D3436;">CFG Weight (<span id="premiumCfgWeightValue">0.5</span>)</label>
                <input type="range" id="premiumCfgWeight" min="0" max="1" step="0.05" value="0.5" {% if not current_user.has_premium %}disabled{% endif %} style="width: 100%; {% if not current_user.has_premium %}opacity: 0.5;{% endif %}">
              </div>
              <!-- Speed Factor -->
              <div class="input-group">
                <label style="font-size: 13px; color: #2D3436;">Speed Factor (<span id="premiumSpeedValue">1</span>)</label>
                <input type="range" id="premiumSpeed" min="0.5" max="2.0" step="0.1" value="1.0" {% if not current_user.has_premium %}disabled{% endif %} style="width: 100%; {% if not current_user.has_premium %}opacity: 0.5;{% endif %}">
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="generate-btn" id="premiumGenerateBtn" {% if not current_user.has_premium %}disabled style="opacity: 0.5; cursor: not-allowed; background: linear-gradient(135deg, #9333ea, #ec4899);"{% else %}style="background: linear-gradient(135deg, #9333ea, #ec4899);"{% endif %}>
          ‚ú® Generate Ultra Voice
        </button>
        
        <p style="text-align: center; font-size: 12px; color: #636E72; margin-top: 12px;">
          ‚ö° GPU-accelerated generation (typically 5-15 seconds)
        </p>
      </div>

      <div class="loading" id="premiumLoading">
        <p id="premiumLoadingText">‚ú® Generating with Chatterbox...</p>
        <p style="font-size: 12px; color: #9333ea; margin-top: 8px;" id="premiumLoadingHint">GPU-powered generation - usually takes 5-15 seconds.</p>
        <div style="margin-top: 12px; height: 4px; background: rgba(147,51,234,0.2); border-radius: 2px; overflow: hidden;">
          <div id="premiumProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #9333ea, #ec4899); border-radius: 2px; transition: width 0.5s ease;"></div>
        </div>
      </div>
      <div class="error" id="premiumError"></div>
      <div class="audio-player" id="premiumAudioPlayer" style="display:none">
        <strong>‚ú® Premium audio ready!</strong>
        <audio id="premiumAudioElement" controls></audio>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <a id="premiumDownloadLink" class="download-btn" download="premium_speech.wav" style="background: linear-gradient(135deg, #9333ea, #ec4899); color: white; border-color: transparent;">‚¨áÔ∏è Download WAV</a>
        </div>
      </div>
    </form>
  </div><!-- End Premium Tab -->

</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if current_user.is_authenticated %}
<script src="{{ url_for('static', filename='dialogue-markup.js') }}"></script>
<script>
  let currentAudioUrl = null;
  let voiceIndex = {};
  let allVoices = [];
  let chunkState = [];
  let presets = [];
  let currentVoiceFilter = 'all';
  let currentTab = 'standard';

  const chunkListEl = document.getElementById('chunkList');
  const textArea = document.getElementById('text');

  // Tab switching
  function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tabStandard').classList.toggle('active', tab === 'standard');
    document.getElementById('tabPremium').classList.toggle('active', tab === 'premium');
    document.getElementById('standardTab').classList.toggle('active', tab === 'standard');
    document.getElementById('premiumTab').classList.toggle('active', tab === 'premium');
  }

  // ===== CHUNK EDITOR MANAGEMENT =====
  let premiumChunks = [];
  let chunkEditorActive = false;

  // Available Chatterbox voices
  const chatterboxVoices = [
    'Emily', 'Michael', 'Olivia', 'Ryan', 'Taylor', 'Thomas',
    'Abigail', 'Adrian', 'Alexander', 'Alice', 'Austin', 'Axel',
    'Connor', 'Cora', 'Elena', 'Eli', 'Everett', 'Gabriel',
    'Gianna', 'Henry', 'Ian', 'Jade', 'Jeremiah', 'Jordan',
    'Julian', 'Layla', 'Leonardo', 'Miles'
  ];

  // Parse text into speaker segments
  function parseTextIntoSegments(text) {
    const voicePattern = chatterboxVoices.join('|');
    const regex = new RegExp(`\\[(${voicePattern}|S\\d+)\\]:\\s*`, 'gi');
    const parts = text.split(regex);
    
    if (parts.length === 1) {
      return [{ voice: null, text: text.trim() }];
    }
    
    const segments = [];
    if (parts[0].trim()) {
      segments.push({ voice: null, text: parts[0].trim() });
    }
    
    for (let i = 1; i < parts.length; i += 2) {
      const speaker = parts[i];
      const segText = parts[i + 1]?.trim();
      if (segText) {
        let voiceName = 'Emily';
        if (speaker.toUpperCase().startsWith('S') && /^\d+$/.test(speaker.slice(1))) {
          const speakerMap = { '1': 'Emily', '2': 'Michael', '3': 'Olivia', '4': 'Ryan', '5': 'Taylor', '6': 'Thomas', '7': 'Jade', '8': 'Alexander' };
          voiceName = speakerMap[speaker.slice(1)] || 'Emily';
        } else {
          const match = chatterboxVoices.find(v => v.toLowerCase() === speaker.toLowerCase());
          voiceName = match || 'Emily';
        }
        segments.push({ voice: voiceName, text: segText });
      }
    }
    return segments;
  }

  // Split text into chunks and show editor
  function splitIntoChunks() {
    const text = document.getElementById('premiumText').value.trim();
    if (!text) {
      alert('Please enter some text first.');
      return;
    }
    
    const segments = parseTextIntoSegments(text);
    const defaultVoice = document.getElementById('premiumVoice').value.replace('.wav', '');
    
    premiumChunks = segments.map((seg, idx) => ({
      id: idx,
      text: seg.text,
      voice: seg.voice || defaultVoice,
      preset: 'standard',
      temperature: 0.8,
      exaggeration: 0.4,
      cfgWeight: 0.5,
      speed: 1.0
    }));
    
    renderChunkEditor();
    chunkEditorActive = true;
    document.getElementById('premiumChunkEditor').style.display = 'block';
    document.getElementById('clearChunksBtn').style.display = 'inline-block';
    document.getElementById('chunkModeIndicator').style.display = 'inline';
    document.getElementById('premiumText').style.display = 'none';
    document.querySelector('.form-section .input-group > p').style.display = 'none';
  }

  // Clear chunks and go back to textarea
  function clearChunks() {
    premiumChunks = [];
    chunkEditorActive = false;
    document.getElementById('premiumChunkEditor').style.display = 'none';
    document.getElementById('clearChunksBtn').style.display = 'none';
    document.getElementById('chunkModeIndicator').style.display = 'none';
    document.getElementById('premiumText').style.display = 'block';
    document.querySelector('.form-section .input-group > p').style.display = 'block';
  }

  // Render chunk editor cards
  function renderChunkEditor() {
    const container = document.getElementById('premiumChunkList');
    container.innerHTML = premiumChunks.map((chunk, idx) => `
      <div class="chunk-card" data-chunk-id="${chunk.id}" style="background: white; border: 2px solid #e9ecef; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <span style="font-weight: 700; color: #9333ea; font-size: 14px;">Chunk ${idx + 1}</span>
          <div style="display: flex; gap: 8px; align-items: center;">
            <select onchange="updateChunkVoice(${chunk.id}, this.value)" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 12px;">
              ${chatterboxVoices.map(v => `<option value="${v}" ${chunk.voice === v ? 'selected' : ''}>${v}</option>`).join('')}
            </select>
            <button type="button" onclick="previewChunk(${chunk.id})" id="previewBtn_${chunk.id}" style="background: linear-gradient(135deg, #3498db, #2980b9); border: none; color: white; cursor: pointer; font-size: 12px; padding: 5px 10px; border-radius: 8px;" title="Preview this chunk">‚ñ∂Ô∏è Preview</button>
            <button type="button" onclick="deleteChunk(${chunk.id})" style="background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 14px;" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
        
        <!-- Mini audio player for preview -->
        <div id="chunkPreview_${chunk.id}" style="display: none; margin-bottom: 12px; padding: 8px; background: #f0f4ff; border-radius: 10px;">
          <audio id="chunkAudio_${chunk.id}" controls style="width: 100%; height: 32px;"></audio>
        </div>
        
        <textarea onchange="updateChunkText(${chunk.id}, this.value)" style="width: 100%; min-height: 60px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; resize: vertical; margin-bottom: 12px;">${chunk.text}</textarea>
        
        <!-- Chatterbox Presets for this chunk -->
        <div style="margin-bottom: 12px;">
          <label style="font-size: 11px; color: #636E72; display: block; margin-bottom: 6px;">üéôÔ∏è Style Preset</label>
          <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            ${['standard', 'expressive', 'technical', 'upbeat', 'thoughtful', 'longstory'].map(p => `
              <button type="button" onclick="applyChunkPreset(${chunk.id}, '${p}')" 
                style="padding: 5px 10px; border-radius: 12px; border: 1px solid ${chunk.preset === p ? '#9333ea' : '#ddd'}; 
                background: ${chunk.preset === p ? 'linear-gradient(135deg, #9333ea, #ec4899)' : 'white'}; 
                color: ${chunk.preset === p ? 'white' : '#636E72'}; font-size: 11px; cursor: pointer;">
                ${p === 'standard' ? 'üéôÔ∏è Standard' : p === 'expressive' ? 'üé≠ Expressive' : p === 'technical' ? 'üìö Technical' : p === 'upbeat' ? 'üì¢ Upbeat' : p === 'thoughtful' ? 'üí≠ Thoughtful' : 'üìñ Story'}
              </button>
            `).join('')}
          </div>
        </div>
        
        <!-- Chatterbox Sliders for this chunk -->
        <details style="margin-top: 8px;">
          <summary style="cursor: pointer; font-size: 12px; color: #636E72; margin-bottom: 8px;">‚öôÔ∏è Fine-tune parameters</summary>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 10px;">
            <div>
              <label style="font-size: 11px; color: #636E72;">Temperature: <span id="chunkTemp_${chunk.id}">${chunk.temperature}</span></label>
              <input type="range" min="0.1" max="1.5" step="0.05" value="${chunk.temperature}" 
                onchange="updateChunkParam(${chunk.id}, 'temperature', this.value); document.getElementById('chunkTemp_${chunk.id}').textContent=this.value" style="width: 100%;">
            </div>
            <div>
              <label style="font-size: 11px; color: #636E72;">Exaggeration: <span id="chunkExag_${chunk.id}">${chunk.exaggeration}</span></label>
              <input type="range" min="0" max="2" step="0.1" value="${chunk.exaggeration}" 
                onchange="updateChunkParam(${chunk.id}, 'exaggeration', this.value); document.getElementById('chunkExag_${chunk.id}').textContent=this.value" style="width: 100%;">
            </div>
            <div>
              <label style="font-size: 11px; color: #636E72;">CFG Weight: <span id="chunkCfg_${chunk.id}">${chunk.cfgWeight}</span></label>
              <input type="range" min="0" max="1" step="0.05" value="${chunk.cfgWeight}" 
                onchange="updateChunkParam(${chunk.id}, 'cfgWeight', this.value); document.getElementById('chunkCfg_${chunk.id}').textContent=this.value" style="width: 100%;">
            </div>
            <div>
              <label style="font-size: 11px; color: #636E72;">Speed: <span id="chunkSpeed_${chunk.id}">${chunk.speed}</span></label>
              <input type="range" min="0.5" max="2" step="0.1" value="${chunk.speed}" 
                onchange="updateChunkParam(${chunk.id}, 'speed', this.value); document.getElementById('chunkSpeed_${chunk.id}').textContent=this.value" style="width: 100%;">
            </div>
          </div>
        </details>
      </div>
    `).join('');
  }

  // Preview a single chunk (limited to 100 chars, free)
  async function previewChunk(id) {
    const chunk = premiumChunks.find(c => c.id === id);
    if (!chunk) return;
    
    const btn = document.getElementById(`previewBtn_${id}`);
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Loading...';
    btn.disabled = true;
    
    try {
      const response = await fetch('/api/preview-chunk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          text: chunk.text.substring(0, 100),  // Max 100 chars for preview
          voice: chunk.voice + '.wav',
          temperature: chunk.temperature,
          exaggeration: chunk.exaggeration,
          cfg_weight: chunk.cfgWeight,
          speed_factor: chunk.speed
        })
      });
      
      const data = await response.json();
      if (data.success) {
        const previewDiv = document.getElementById(`chunkPreview_${id}`);
        const audio = document.getElementById(`chunkAudio_${id}`);
        audio.src = data.audioUrl;
        previewDiv.style.display = 'block';
        audio.play();
      } else {
        alert('Preview failed: ' + (data.error || 'Unknown error'));
      }
    } catch (err) {
      alert('Preview error: ' + err.message);
    } finally {
      btn.innerHTML = originalText;
      btn.disabled = false;
    }
  }

  function updateChunkText(id, text) {
    const chunk = premiumChunks.find(c => c.id === id);
    if (chunk) chunk.text = text;
  }

  function updateChunkVoice(id, voice) {
    const chunk = premiumChunks.find(c => c.id === id);
    if (chunk) chunk.voice = voice;
  }

  function updateChunkParam(id, param, value) {
    const chunk = premiumChunks.find(c => c.id === id);
    if (chunk) chunk[param] = parseFloat(value);
  }

  function applyChunkPreset(id, presetKey) {
    const chunk = premiumChunks.find(c => c.id === id);
    if (!chunk) return;
    
    const preset = premiumPresets[presetKey];
    if (!preset) return;
    
    chunk.preset = presetKey;
    chunk.temperature = preset.temperature;
    chunk.exaggeration = preset.exaggeration;
    chunk.cfgWeight = preset.cfgWeight;
    chunk.speed = preset.speed;
    
    renderChunkEditor();
  }

  function deleteChunk(id) {
    premiumChunks = premiumChunks.filter(c => c.id !== id);
    if (premiumChunks.length === 0) {
      clearChunks();
    } else {
      renderChunkEditor();
    }
  }

  // Collect chunks for submission
  function collectChunksForSubmission() {
    return premiumChunks.map(chunk => ({
      text: chunk.text,
      voice: chunk.voice + '.wav',
      temperature: chunk.temperature,
      exaggeration: chunk.exaggeration,
      cfg_weight: chunk.cfgWeight,
      speed_factor: chunk.speed
    }));
  }

  // Premium TTS Form Handler
  document.getElementById('premiumTtsForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const text = document.getElementById('premiumText').value.trim();
    const voice = document.getElementById('premiumVoice').value;
    const exaggeration = parseFloat(document.getElementById('premiumExaggeration').value);
    const cfgWeight = parseFloat(document.getElementById('premiumCfgWeight').value);
    const temperature = parseFloat(document.getElementById('premiumTemperature').value);
    const speedFactor = parseFloat(document.getElementById('premiumSpeed').value);
    const generateBtn = document.getElementById('premiumGenerateBtn');
    const loading = document.getElementById('premiumLoading');
    const error = document.getElementById('premiumError');
    const audioPlayer = document.getElementById('premiumAudioPlayer');
    const progressBar = document.getElementById('premiumProgressBar');
    const loadingText = document.getElementById('premiumLoadingText');
    
    // Check if using chunk editor
    const useChunks = chunkEditorActive && premiumChunks.length > 0;
    
    if (!useChunks && !text) {
      error.textContent = 'Please enter some text.';
      error.classList.add('visible');
      return;
    }
    
    // Show loading with animated progress
    generateBtn.disabled = true;
    loading.classList.add('visible');
    error.classList.remove('visible');
    audioPlayer.style.display = 'none';
    
    // Animate progress bar for GPU mode (faster)
    let progress = 0;
    progressBar.style.width = '0%';
    const progressInterval = setInterval(() => {
      if (progress < 95) {
        progress += Math.random() * 8; // Faster progress for GPU mode
        if (progress > 95) progress = 95;
        progressBar.style.width = progress + '%';
        
        // Update loading text based on progress
        if (progress > 10 && progress < 40) {
          loadingText.textContent = 'üé§ Generating with Chatterbox...';
        } else if (progress > 40 && progress < 70) {
          loadingText.textContent = 'üîä Processing audio...';
        } else if (progress > 70) {
          loadingText.textContent = '‚ú® Almost ready...';
        }
      }
    }, 500);
    
    try {
      // Build request - either chunks mode or text mode
      const requestBody = useChunks ? {
        chunks: collectChunksForSubmission(),
        voice: voice  // fallback
      } : {
        text: text,
        voice: voice,
        exaggeration: exaggeration,
        cfg_weight: cfgWeight,
        temperature: temperature,
        speed_factor: speedFactor
      };
      
      const response = await fetch('/api/generate-premium', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody)
      });
      
      clearInterval(progressInterval);
      progressBar.style.width = '100%';
      
      const data = await response.json();
      
      if (data.success) {
        // Update usage display
        const usedEl = document.getElementById('premiumCharsUsed');
        if (usedEl) usedEl.textContent = data.premium_chars_used || 0;
        
        // Show audio player
        document.getElementById('premiumAudioElement').src = data.audioUrl;
        document.getElementById('premiumDownloadLink').href = data.audioUrl;
        audioPlayer.style.display = 'block';
      } else {
        error.textContent = data.error || 'Failed to generate audio.';
        error.classList.add('visible');
        
        if (data.premium_required) {
          error.innerHTML = data.error + ' <a href="/subscribe" style="color: #9333ea; font-weight: 600;">Upgrade Now ‚Üí</a>';
        }
      }
    } catch (err) {
      clearInterval(progressInterval);
      console.error(err);
      error.textContent = 'Network error. Please try again.';
      error.classList.add('visible');
    } finally {
      generateBtn.disabled = false;
      loading.classList.remove('visible');
    }
  });
  
  // EXACT Chatterbox preset definitions from ui/presets.yaml
  const premiumPresets = {
    standard: {
      name: 'Standard Narration',
      temperature: 0.8,
      exaggeration: 0.4,
      cfgWeight: 0.5,
      speed: 1.0
    },
    expressive: {
      name: 'Expressive Monologue',
      temperature: 0.75,
      exaggeration: 1.1,
      cfgWeight: 0.6,
      speed: 1.0
    },
    technical: {
      name: 'Technical Explanation',
      temperature: 0.85,
      exaggeration: 0.4,
      cfgWeight: 0.5,
      speed: 1.0
    },
    upbeat: {
      name: 'Upbeat Advertisement',
      temperature: 0.8,
      exaggeration: 1.3,
      cfgWeight: 0.45,
      speed: 1.0
    },
    thoughtful: {
      name: 'Thoughtful Reflection',
      temperature: 0.7,
      exaggeration: 0.4,
      cfgWeight: 0.6,
      speed: 1.0
    },
    punctuation: {
      name: 'Simple Punctuation',
      temperature: 0.8,
      exaggeration: 0.5,
      cfgWeight: 0.5,
      speed: 1.0
    },
    longstory: {
      name: 'Long Story Excerpt',
      temperature: 0.78,
      exaggeration: 1.1,
      cfgWeight: 0.55,
      speed: 1.0
    }
  };

  // Update slider display values
  function updateSliderDisplays() {
    document.getElementById('premiumTemperatureValue').textContent = document.getElementById('premiumTemperature').value;
    document.getElementById('premiumExaggerationValue').textContent = document.getElementById('premiumExaggeration').value;
    document.getElementById('premiumCfgWeightValue').textContent = document.getElementById('premiumCfgWeight').value;
    document.getElementById('premiumSpeedValue').textContent = document.getElementById('premiumSpeed').value;
  }

  // Slider input handlers
  ['premiumTemperature', 'premiumExaggeration', 'premiumCfgWeight', 'premiumSpeed'].forEach(id => {
    document.getElementById(id)?.addEventListener('input', updateSliderDisplays);
  });

  // Preset button click handler
  document.querySelectorAll('.preset-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const preset = this.dataset.preset;
      const settings = premiumPresets[preset];
      if (!settings) return;
      
      // Update sliders with preset values
      document.getElementById('premiumExaggeration').value = settings.exaggeration;
      document.getElementById('premiumCfgWeight').value = settings.cfgWeight;
      document.getElementById('premiumTemperature').value = settings.temperature;
      document.getElementById('premiumSpeed').value = settings.speed;
      
      // Update display values
      updateSliderDisplays();
      
      // Update button styles
      document.querySelectorAll('.preset-btn').forEach(b => {
        b.classList.remove('active');
        b.style.background = 'transparent';
        b.style.color = '#9333ea';
      });
      this.classList.add('active');
      this.style.background = 'linear-gradient(135deg, #9333ea, #ec4899)';
      this.style.color = 'white';
    });
  });

  async function loadVoices() {
    try {
      const response = await fetch('/api/voices');
      const data = await response.json();
      if (data.success) {
        voiceIndex = {};
        allVoices = data.voices;

        // Store voice data for emotion control
        data.voices.forEach(v => {
          voiceIndex[v.shortName] = v;
        });

        // Update emotion count badge
        const emotionVoices = data.voices.filter(v => v.has_styles);
        const emotionCountEl = document.getElementById('emotionCount');
        if (emotionCountEl) emotionCountEl.textContent = emotionVoices.length;

        // Render voices with default filter
        renderVoiceOptions();

        // Add change listener for emotion control
        document.getElementById('voice').addEventListener('change', onVoiceChange);
        onVoiceChange();
      }
    } catch (err) {
      console.error(err);
      const el = document.getElementById('error');
      el.textContent = 'Failed to load voices. Please refresh.';
      el.classList.add('visible');
    }
  }

  function filterVoices(filter) {
    currentVoiceFilter = filter;
    
    // Update button states
    document.getElementById('filterAll').classList.toggle('active', filter === 'all');
    document.getElementById('filterEmotions').classList.toggle('active', filter === 'emotions');
    
    renderVoiceOptions();
  }

  function renderVoiceOptions() {
    const voiceSelect = document.getElementById('voice');
    const languageFilter = document.getElementById('languageFilter').value;
    const previousValue = voiceSelect.value;
    voiceSelect.innerHTML = '';

    // Filter voices based on current filters
    let filteredVoices = allVoices;
    
    // Apply emotion filter
    if (currentVoiceFilter === 'emotions') {
      filteredVoices = filteredVoices.filter(v => v.has_styles);
    }
    
    // Apply language filter
    if (languageFilter !== 'all') {
      if (languageFilter === 'other') {
        const mainLangs = ['en', 'es', 'fr', 'de', 'it', 'pt', 'zh', 'ja', 'ko', 'ar', 'hi'];
        filteredVoices = filteredVoices.filter(v => !mainLangs.some(lang => v.locale.startsWith(lang)));
      } else {
        filteredVoices = filteredVoices.filter(v => v.locale.startsWith(languageFilter));
      }
    }

    // Group voices
    const emotionVoices = filteredVoices.filter(v => v.has_styles);
    const regularVoices = filteredVoices.filter(v => !v.has_styles);

    // Add emotion voices first (if showing all)
    if (currentVoiceFilter === 'all' && emotionVoices.length > 0) {
      const emotionGroup = document.createElement('optgroup');
      emotionGroup.label = `üé≠ Voices with Emotions (${emotionVoices.length})`;
      emotionVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.shortName;
        option.textContent = `üé≠ ${voice.localName} (${voice.gender}) - ${voice.locale}`;
        option.dataset.hasStyles = voice.has_styles;
        option.dataset.styles = (voice.styles || []).join(',');
        emotionGroup.appendChild(option);
      });
      voiceSelect.appendChild(emotionGroup);
    } else if (currentVoiceFilter === 'emotions') {
      // Just list them without grouping
      emotionVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.shortName;
        option.textContent = `üé≠ ${voice.localName} (${voice.gender}) - ${voice.locale}`;
        option.dataset.hasStyles = voice.has_styles;
        option.dataset.styles = (voice.styles || []).join(',');
        voiceSelect.appendChild(option);
      });
    }

    // Add regular voices
    if (currentVoiceFilter === 'all' && regularVoices.length > 0) {
      const regularGroup = document.createElement('optgroup');
      regularGroup.label = `Standard Voices (${regularVoices.length})`;
      regularVoices.forEach(voice => {
        const option = document.createElement('option');
        option.value = voice.shortName;
        option.textContent = `${voice.localName} (${voice.gender}) - ${voice.locale}`;
        option.dataset.hasStyles = voice.has_styles;
        option.dataset.styles = (voice.styles || []).join(',');
        regularGroup.appendChild(option);
      });
      voiceSelect.appendChild(regularGroup);
    }

    // Restore previous selection if still available, otherwise pick a good default
    if (previousValue && voiceIndex[previousValue]) {
      const stillExists = Array.from(voiceSelect.options).some(opt => opt.value === previousValue);
      if (stillExists) {
        voiceSelect.value = previousValue;
      } else {
        // Pick first emotion voice if filtering by emotions, otherwise Emma
        voiceSelect.value = voiceSelect.options[0]?.value || '';
      }
    } else {
      // Default to first emotion voice if available
      const firstEmotionVoice = emotionVoices[0];
      if (firstEmotionVoice) {
        voiceSelect.value = firstEmotionVoice.shortName;
      }
    }

    // Update count display
    const totalShown = filteredVoices.length;
    const voiceCountEl = document.getElementById('voiceCount');
    if (voiceCountEl) {
      if (currentVoiceFilter === 'emotions') {
        voiceCountEl.innerHTML = `Showing <strong>${totalShown}</strong> voices with emotion control`;
      } else {
        voiceCountEl.innerHTML = `Showing <strong>${totalShown}</strong> voices (${emotionVoices.length} with emotions)`;
      }
    }

    onVoiceChange();
  }

  function onVoiceChange() {
    const voiceSelect = document.getElementById('voice');
    const styleGroup = document.getElementById('styleGroup');
    const styleSelect = document.getElementById('style');
    const selectedVoice = voiceIndex[voiceSelect.value];

    // Reset styles
    styleSelect.innerHTML = '<option value="">Default (no style)</option>';

    if (selectedVoice && selectedVoice.styles && selectedVoice.styles.length) {
      selectedVoice.styles.forEach(style => {
        const opt = document.createElement('option');
        opt.value = style;
        opt.textContent = style.charAt(0).toUpperCase() + style.slice(1);
        styleSelect.appendChild(opt);
      });
      styleGroup.style.display = 'block';
    } else {
      styleGroup.style.display = 'none';
      styleSelect.value = '';
      // Strip any per-chunk emotion if voice has no styles
      chunkState = chunkState.map(c => ({ ...c, emotion: null }));
    }
    enforceChunkEmotionForVoice();
    renderChunks(); // Refresh options in timeline
  }

  async function loadPresets() {
    try {
      const res = await fetch('/api/presets');
      const data = await res.json();
      if (data.success) {
        presets = data.presets || [];
        const presetSelect = document.getElementById('preset');
        const presetDesc = document.getElementById('presetDesc');
        presets.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = p.label;
          presetSelect.appendChild(opt);
        });
        presetSelect.addEventListener('change', () => {
          const selected = presets.find(p => p.id === presetSelect.value);
          if (!selected) { presetDesc.textContent = ''; return; }
          presetDesc.textContent = selected.description || '';
          // apply voice
          const voiceSel = document.getElementById('voice');
          voiceSel.value = selected.voice;
          onVoiceChange();
          // apply style/emotion if available
          const styleSel = document.getElementById('style');
          if (selected.emotion) {
            styleSel.value = selected.emotion;
          }
          // apply sliders
          const setSlider = (id, val) => {
            const el = document.getElementById(id);
            el.value = val;
            el.dispatchEvent(new Event('input'));
          };
          setSlider('rate', selected.rate || 0);
          setSlider('pitch', selected.pitch || 0);
          setSlider('volume', (selected.volume || 0) * 5); // volume is dB, slider is percent bucket
          // reset chunks to match preset emotion as default
          chunkState.forEach(c => { c.emotion = selected.emotion || null; });
          renderChunks();
        });
      }
    } catch (err) {
      console.warn('Failed to load presets', err);
    }
  }

  function getCurrentStyles() {
    const selectedVoice = voiceIndex[document.getElementById('voice').value];
    return (selectedVoice && selectedVoice.styles) ? selectedVoice.styles : [];
  }

  function enforceChunkEmotionForVoice() {
    const allowed = getCurrentStyles();
    const styleSel = document.getElementById('style');
    if (!allowed.length) {
      styleSel.value = '';
    } else if (styleSel.value && !allowed.includes(styleSel.value)) {
      styleSel.value = '';
    }
    chunkState = chunkState.map(c => {
      if (!allowed.length) { return { ...c, emotion: null }; }
      if (c.emotion && !allowed.includes(c.emotion)) { return { ...c, emotion: null }; }
      return c;
    });
  }

  function splitTextIntoChunks(inputText) {
    const cleaned = (inputText || '').trim();
    if (!cleaned) { return []; }
    const parts = [];
    const tokens = cleaned.split(/(\.{3,}|‚Ä¶|[.!?]|[,;]|‚Äî)/);
    let buf = '';
    tokens.forEach(tok => {
      if (!tok) { return; }
      if (/(\.{3,}|‚Ä¶|[.!?]|[,;]|‚Äî)/.test(tok)) {
        buf += tok;
        parts.push(buf.trim());
        buf = '';
      } else {
        if (buf) { parts.push(buf.trim()); buf = ''; }
        buf = tok;
      }
    });
    if (buf.trim()) { parts.push(buf.trim()); }
    // merge tiny fragments
    const merged = [];
    parts.forEach(p => {
      if (merged.length && p.length < 15) {
        merged[merged.length - 1] = (merged[merged.length - 1] + ' ' + p).trim();
      } else {
        merged.push(p);
      }
    });
    // split overly long
    const finalChunks = [];
    merged.forEach(p => {
      if (p.length <= 240) { finalChunks.push(p); return; }
      const words = p.split(/\s+/);
      let buf2 = [];
      words.forEach(w => {
        const joined = [...buf2, w].join(' ');
        if (joined.length > 240 && buf2.length) {
          finalChunks.push(buf2.join(' '));
          buf2 = [w];
        } else {
          buf2.push(w);
        }
      });
      if (buf2.length) { finalChunks.push(buf2.join(' ')); }
    });
    return finalChunks;
  }

  function mergeSmallChunks(state, minLen = 20) {
    const merged = [];
    state.forEach(chunk => {
      if (merged.length && chunk.content.length < minLen) {
        merged[merged.length - 1].content = (merged[merged.length - 1].content + ' ' + chunk.content).trim();
      } else {
        merged.push({ ...chunk });
      }
    });
    return merged;
  }

  function rebuildTimelineFromText() {
    const inputText = textArea.value.trim();
    if (!inputText) return;

    // Auto-detect if text has dialogue markup
    if (typeof hasDialogueMarkup !== 'undefined' && hasDialogueMarkup(inputText)) {
      // Parse as dialogue markup
      chunkState = parseDialogueMarkup(inputText);

      // Show success message
      const infoMsg = document.createElement('div');
      infoMsg.style.cssText = 'background: #eff6ff; border: 1px solid #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 12px; color: #3b82f6; font-size: 14px;';
      infoMsg.textContent = `‚ú® Detected dialogue markup! Created ${chunkState.length} chunks from your text.`;
      setTimeout(() => infoMsg.remove(), 5000);
      chunkListEl.insertBefore(infoMsg, chunkListEl.firstChild);
    } else {
      // Regular text splitting
      const baseEmotion = document.getElementById('style').value || null;
      const splits = splitTextIntoChunks(inputText);
      chunkState = splits.map(c => ({
        content: c,
        emotion: baseEmotion,
        intensity: 2,
        pitch: 0,
        speed: 0,
        volume: 0
      }));
    }

    renderChunks();
  }

  function renderChunks() {
    if (!chunkListEl) { return; }
    chunkListEl.innerHTML = '';
    const clearBtn = document.getElementById('btnReset');
    if (!chunkState.length) {
      chunkListEl.innerHTML = '<p style="color:#9ca3af; font-size:13px;">No chunks yet. Click "Split Text into Chunks" to generate chunks from your text.</p>';
      if (clearBtn) clearBtn.style.display = 'none';
      return;
    }
    if (clearBtn) clearBtn.style.display = 'inline-block';
    const styles = getCurrentStyles();
    chunkState.forEach((chunk, idx) => {
      const card = document.createElement('div');
      card.className = 'chunk-card';
      const header = document.createElement('div');
      header.className = 'chunk-header';
      header.textContent = `Chunk ${idx + 1}`;
      card.appendChild(header);

      const contentArea = document.createElement('textarea');
      contentArea.className = 'chunk-content';
      contentArea.value = chunk.content;
      contentArea.addEventListener('input', (e) => {
        chunkState[idx].content = e.target.value;
      });
      card.appendChild(contentArea);

      const grid = document.createElement('div');
      grid.className = 'chunk-grid';

      // Voice selection
      const voiceWrap = document.createElement('div');
      const voiceLabel = document.createElement('label');
      voiceLabel.textContent = 'üéôÔ∏è Voice';
      const voiceSelect = document.createElement('select');
      voiceSelect.innerHTML = '<option value="">Use Global Voice</option>';

      // Add recommended voices
      const recommendedGroup = document.createElement('optgroup');
      recommendedGroup.label = '‚≠ê Recommended Multi-Speaker';
      const jennyOpt = document.createElement('option');
      jennyOpt.value = 'en-US-JennyNeural';
      jennyOpt.textContent = 'üé≠ Jenny (14 emotions)';
      recommendedGroup.appendChild(jennyOpt);
      const guyOpt = document.createElement('option');
      guyOpt.value = 'en-US-GuyNeural';
      guyOpt.textContent = 'üé≠ Guy (11 emotions)';
      recommendedGroup.appendChild(guyOpt);
      voiceSelect.appendChild(recommendedGroup);

      // Add all voices
      const allVoicesGroup = document.createElement('optgroup');
      allVoicesGroup.label = 'All Voices';
      Object.keys(voiceIndex).forEach(shortName => {
        const voice = voiceIndex[shortName];
        const opt = document.createElement('option');
        opt.value = shortName;
        opt.textContent = `${voice.has_styles ? 'üé≠ ' : ''}${voice.localName} (${voice.gender})`;
        opt.dataset.hasStyles = voice.has_styles;
        opt.dataset.styles = (voice.styles || []).join(',');
        allVoicesGroup.appendChild(opt);
      });
      voiceSelect.appendChild(allVoicesGroup);

      voiceSelect.value = chunk.voice || '';
      voiceSelect.addEventListener('change', (e) => {
        chunkState[idx].voice = e.target.value || null;
        // Update available emotions based on selected voice
        renderChunks();
      });
      voiceWrap.appendChild(voiceLabel);
      voiceWrap.appendChild(voiceSelect);
      grid.appendChild(voiceWrap);

      // Emotion selection - filtered by chunk's voice
      const emotionWrap = document.createElement('div');
      const emotionLabel = document.createElement('label');
      emotionLabel.textContent = 'üé≠ Emotion';
      const emotionSelect = document.createElement('select');
      emotionSelect.innerHTML = '<option value="">Default</option>';

      // Get styles for chunk's specific voice, or fall back to global voice
      let chunkStyles = styles;
      if (chunk.voice && voiceIndex[chunk.voice]) {
        chunkStyles = voiceIndex[chunk.voice].styles || [];
      }

      chunkStyles.forEach(style => {
        const opt = document.createElement('option');
        opt.value = style;
        opt.textContent = style.charAt(0).toUpperCase() + style.slice(1);
        emotionSelect.appendChild(opt);
      });
      emotionSelect.value = chunk.emotion || '';
      emotionSelect.addEventListener('change', (e) => {
        chunkState[idx].emotion = e.target.value || null;
      });
      emotionWrap.appendChild(emotionLabel);
      emotionWrap.appendChild(emotionSelect);
      grid.appendChild(emotionWrap);

      const intensityWrap = document.createElement('div');
      const intensityLabel = document.createElement('label');
      intensityLabel.textContent = 'Intensity (1-3)';
      const intensityInput = document.createElement('input');
      intensityInput.type = 'range';
      intensityInput.min = 1;
      intensityInput.max = 3;
      intensityInput.step = 1;
      intensityInput.value = chunk.intensity || 2;
      intensityInput.addEventListener('input', (e) => {
        chunkState[idx].intensity = parseInt(e.target.value);
      });
      intensityWrap.appendChild(intensityLabel);
      intensityWrap.appendChild(intensityInput);
      grid.appendChild(intensityWrap);

      // Speed and Pitch controls hidden - not effective for multi-voice TTS
      // Keeping the state variables but not showing UI
      chunkState[idx].speed = 0;
      chunkState[idx].pitch = 0;

      card.appendChild(grid);

      const actions = document.createElement('div');
      actions.className = 'chunk-actions';
      const previewBtn = document.createElement('button');
      previewBtn.type = 'button';
      previewBtn.textContent = 'Preview chunk';
      previewBtn.addEventListener('click', () => previewChunk(idx, previewBtn));
      actions.appendChild(previewBtn);
      card.appendChild(actions);

      chunkListEl.appendChild(card);
    });
  }

  function bindSlider(sliderId, outId, suffix) {
    const s = document.getElementById(sliderId), d = document.getElementById(outId);
    s.addEventListener('input', () => {
      const v = parseInt(s.value);
      d.textContent = v === 0 ? 'Normal' : ((v > 0 ? '+' : '') + v + suffix);
    });
  }
  bindSlider('rate', 'rateValue', '%');
  bindSlider('volume', 'volumeValue', '%');
  bindSlider('pitch', 'pitchValue', 'Hz');

  document.getElementById('btnSplit').addEventListener('click', rebuildTimelineFromText);
  document.getElementById('btnReset').addEventListener('click', () => { chunkState = []; renderChunks(); });

  async function previewChunk(idx, btn) {
    const chunk = chunkState[idx];
    if (!chunk || !chunk.content) { return; }
    btn.disabled = true;
    btn.textContent = 'Previewing...';
    try {
      const voice = document.getElementById('voice').value || 'en-US-EmmaMultilingualNeural';
      const payload = {
        voice,
        chunk,
        auto_pauses: document.getElementById('autoPauses').checked,
        auto_emphasis: document.getElementById('autoEmphasis').checked,
        auto_breaths: document.getElementById('autoBreaths').checked,
        global_pitch: Number(document.getElementById('pitch').value || 0),
        global_rate: Number(document.getElementById('rate').value || 0),
        global_volume: Number(document.getElementById('volume').value || 0) / 5
      };
      const res = await fetch('/api/preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      const data = await res.json();
      if (!data.success) { throw new Error(data.error || 'Preview failed'); }
      const audio = document.getElementById('audioElement');
      audio.src = data.audioUrl;
      document.getElementById('downloadLink').href = data.audioUrl;
      document.getElementById('audioPlayer').style.display = 'block';
      // Clear any previous warnings (internal technical info, not shown to users)
      document.getElementById('warningList').textContent = '';
      audio.play();
    } catch (err) {
      const el = document.getElementById('error');
      el.textContent = 'Preview error: ' + err.message;
      el.classList.add('visible');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Preview chunk';
    }
  }

  document.getElementById('ttsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = document.getElementById('text').value;
    const voice = document.getElementById('voice').value;
    const style = document.getElementById('style').value;
    const rate = document.getElementById('rate').value;
    const volume = document.getElementById('volume').value;
    const pitch = document.getElementById('pitch').value;
    const autoPauses = document.getElementById('autoPauses').checked;
    const autoEmphasis = document.getElementById('autoEmphasis').checked;
    const autoBreaths = document.getElementById('autoBreaths').checked;
    const generateSrt = document.getElementById('generateSrt').checked;

    if (!text || !voice) {
      const el = document.getElementById('error');
      el.textContent = 'Please enter text and choose a voice.';
      el.classList.add('visible');
      return;
    }

    const payloadChunks = (chunkState.length ? chunkState : splitTextIntoChunks(text).map(c => ({
      content: c,
      emotion: style || null,
      intensity: 2,
      pitch: 0,
      speed: 0,
      volume: 0
    })));

    document.getElementById('loading').classList.add('visible');
    document.getElementById('error').classList.remove('visible');
    document.getElementById('audioPlayer').style.display = 'none';
    document.getElementById('downloadSrtLink').style.display = 'none';
    document.getElementById('generateBtn').disabled = true;
    try {
      const requestBody = {
        voice,
        chunks: payloadChunks.map(ch => ({
          content: ch.content,
          voice: ch.voice || null,  // Include per-chunk voice selection
          emotion: ch.emotion || null,
          intensity: ch.intensity || 2,
          pitch: Number(ch.pitch || 0),
          speed: Number(ch.speed || 0),
          volume: Number(ch.volume || 0)
        })),
        auto_pauses: autoPauses,
        auto_emphasis: autoEmphasis,
        auto_breaths: autoBreaths,
        generate_srt: generateSrt,
        global_controls: {
          rate: Number(rate || 0),
          pitch: Number(pitch || 0),
          // volume slider is -50..50; map to -10..10 dB to stay safe
          volume: Number(volume || 0) / 5
        }
      };
      const res = await fetch('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody) });
      const data = await res.json();
      if (data.success) {
        if (currentAudioUrl) { URL.revokeObjectURL(currentAudioUrl); }
        currentAudioUrl = data.audioUrl;
        const audio = document.getElementById('audioElement');
        audio.src = data.audioUrl;
        const dl = document.getElementById('downloadLink');
        dl.href = data.audioUrl;
        document.getElementById('audioPlayer').style.display = 'block';
        
        // Show SRT download button if SRT was generated
        const srtLink = document.getElementById('downloadSrtLink');
        if (data.srtUrl) {
          srtLink.href = data.srtUrl;
          srtLink.style.display = 'inline-flex';
        } else {
          srtLink.style.display = 'none';
        }
        
        audio.play();
        
        // Update character usage display if data is provided
        if (data.chars_used !== undefined && data.chars_limit !== undefined) {
          updateUsageDisplay(data.chars_used, data.chars_limit, data.chars_remaining);
        }
      } else {
        // Check if it's a character limit error
        if (data.error && data.error.includes('character limit')) {
          const el = document.getElementById('error');
          el.innerHTML = `<div style="display: flex; flex-direction: column; gap: 10px;">
            <span>‚ö†Ô∏è ${data.error}</span>
            <a href="/subscribe" style="display: inline-block; padding: 10px 20px; background: #f97316; color: white; border-radius: 8px; text-decoration: none; font-weight: 600; text-align: center;">
              ‚≠ê Upgrade for Unlimited Characters
            </a>
          </div>`;
          el.classList.add('visible');
        } else {
          throw new Error(data.error || 'Failed to generate');
        }
      }
    } catch (err) {
      const el = document.getElementById('error');
      el.textContent = 'Error: ' + err.message;
      el.classList.add('visible');
    } finally {
      document.getElementById('loading').classList.remove('visible');
      document.getElementById('generateBtn').disabled = false;
    }
  });
  
  // Function to update the usage display dynamically
  function updateUsageDisplay(charsUsed, charsLimit, charsRemaining) {
    const usageText = document.getElementById('usageText');
    const usageBar = document.getElementById('usageBar');
    const remainingText = document.getElementById('remainingText');
    const usageIcon = document.getElementById('usageIcon');
    const upgradeBtn = document.getElementById('upgradeBtn');
    
    if (!usageText) return;
    
    // Don't update display for unlimited users - keep the ‚àû Unlimited text
    if (usageText.dataset.unlimited === 'true') return;
    
    const percent = charsLimit > 0 ? (charsUsed / charsLimit) * 100 : 0;
    
    usageText.textContent = `${Math.round(charsUsed)} / ${Math.round(charsLimit)} characters`;
    if (usageBar) {
      usageBar.style.width = `${Math.min(percent, 100)}%`;
      usageBar.style.background = percent >= 100 ? '#ef4444' : percent >= 80 ? '#f97316' : 'linear-gradient(135deg, #FF9A8B, #FF8E53)';
    }
    if (remainingText) {
      remainingText.textContent = `${Math.round(charsRemaining)} characters remaining this month`;
    }
    if (usageIcon) {
      usageIcon.textContent = percent >= 100 ? 'üö´' : percent >= 80 ? '‚ö†Ô∏è' : 'üìà';
    }
    
    // Show/update upgrade button if needed
    if (percent >= 80) {
      if (!upgradeBtn) {
        // Create upgrade button if it doesn't exist
        const container = remainingText?.parentElement;
        if (container) {
          const btn = document.createElement('a');
          btn.id = 'upgradeBtn';
          btn.href = '/subscribe';
          btn.style.cssText = `
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: 10px;
            background: ${percent >= 100 ? '#ef4444' : '#f97316'};
            color: white; font-size: 13px; font-weight: 600;
            text-decoration: none; transition: all 0.2s;
          `;
          btn.innerHTML = `‚≠ê ${percent >= 100 ? 'Upgrade for Unlimited' : 'Upgrade Now'}`;
          container.appendChild(btn);
        }
      } else {
        upgradeBtn.style.background = percent >= 100 ? '#ef4444' : '#f97316';
        upgradeBtn.innerHTML = `‚≠ê ${percent >= 100 ? 'Upgrade for Unlimited' : 'Upgrade Now'}`;
      }
    }
  }
  
  loadVoices();
  loadPresets();
  renderChunks();
</script>
{% endif %}

<div style="text-align: center; margin-top: 60px; padding: 20px; color: #9ca3af; font-size: 14px;">
  Need help? Contact us at <a href="mailto:support@cheaptts.com"
    style="color: #7c3aed; text-decoration: none;">support@cheaptts.com</a>
</div>
{% endblock %}