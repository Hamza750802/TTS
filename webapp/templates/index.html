{% extends 'base.html' %}
{% block title %}Cheap TTS — Text to Speech Dashboard{% endblock %}
{% block head %}
<style>
  .tts-container{max-width:900px;margin:0 auto;padding:24px 0}
  .controls{display:grid;grid-template-columns:1fr;gap:20px;margin-top:24px}
  @media (min-width: 720px){.controls{grid-template-columns:1fr 1fr}}
  .row{display:grid;gap:14px}
  .slider-row{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center}
  .pill{padding:12px 16px;border-radius:12px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);color:var(--text);font-size:15px}
  .pill:focus{outline:none;border-color:rgba(124,58,237,.5);box-shadow:0 0 0 3px rgba(124,58,237,.15)}
  select.pill{background:rgba(0,0,0,.35);color:var(--text);cursor:pointer}
  select.pill option{background:#1e293b;color:#e5e7eb;padding:8px}
  textarea.pill{min-height:180px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace;line-height:1.6}
  .button{width:100%;padding:16px 20px;border-radius:12px;border:none;cursor:pointer;color:white;font-weight:700;font-size:16px;background:linear-gradient(135deg,#7c3aed,#06b6d4);box-shadow:0 10px 28px rgba(124,58,237,.45);transition:transform .15s ease}
  .button:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(124,58,237,.55)}
  .button:disabled{opacity:0.6;cursor:not-allowed;transform:none}
  .audio{margin-top:24px;padding:20px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.04)}
  .loading{display:none;text-align:center;color:#c4b5fd;font-weight:700;margin-top:20px}
  .loading.visible{display:block}
  .error{display:none;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);padding:14px;border-radius:10px;margin-top:20px}
  .error.visible{display:block}
  .download{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);transition:all .2s}
  .download:hover{background:rgba(255,255,255,.08);transform:translateY(-1px)}
  .cta{display:grid;gap:14px;text-align:center;max-width:600px;margin:60px auto}
  .cta h3{margin:0;font-size:28px}
  .cta p{margin:0;color:#9ca3af;font-size:16px}
  .cta .actions{display:flex;gap:10px;justify-content:center;margin-top:10px}
  label{font-size:14px;font-weight:600;color:#dbe3ef;letter-spacing:0.3px}
  input[type="range"]{width:100px}
</style>
{% endblock %}

{% block content %}
  {% if not current_user.is_authenticated %}
    <div class="cta">
      <h3>Sign in to start creating audio</h3>
      <p>Create an account and subscribe for $7.99/month</p>
      <div class="actions">
        <a class="btn" href="{{ url_for('login') }}">Sign in</a>
        <a class="btn primary" href="{{ url_for('signup') }}">Sign up</a>
      </div>
    </div>
  {% elif not current_user.is_subscribed %}
    <div class="cta">
      <h3>Subscribe to unlock Text‑to‑Speech</h3>
      <p>Unlimited generation. Cancel anytime.</p>
      <div class="actions">
        <a class="btn primary" href="{{ url_for('subscribe') }}">Subscribe $7.99/month</a>
      </div>
    </div>
  {% else %}
    <div class="tts-container">
      <form id="ttsForm" class="grid">
        <div class="row">
          <label for="text">Enter Text</label>
          <textarea id="text" class="pill" placeholder="Type or paste text to convert to speech..." required></textarea>
        </div>
        <div class="controls">
          <div class="row">
            <label for="voice">Voice</label>
            <select id="voice" class="pill" required>
              <option value="">Loading voices...</option>
            </select>
          </div>
          <div class="row">
            <label>Adjustments</label>
            <div class="row">
              <div class="slider-row">
                <span class="muted">Speed <span id="rateValue" class="muted">Normal</span></span>
                <input type="range" id="rate" min="-50" max="50" value="0" step="5" />
              </div>
              <div class="slider-row">
                <span class="muted">Volume <span id="volumeValue" class="muted">Normal</span></span>
                <input type="range" id="volume" min="-50" max="50" value="0" step="5" />
              </div>
              <div class="slider-row">
                <span class="muted">Pitch <span id="pitchValue" class="muted">Normal</span></span>
                <input type="range" id="pitch" min="-50" max="50" value="0" step="5" />
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="button" id="generateBtn">Generate Speech</button>

        <div class="loading" id="loading">
          <p>Generating speech...</p>
        </div>
        <div class="error" id="error"></div>
        <div class="audio" id="audioPlayer" style="display:none">
          <strong>Your audio is ready</strong>
          <audio id="audioElement" controls style="width:100%;margin-top:12px"></audio>
          <br />
          <a id="downloadLink" class="download" download="speech.mp3">Download MP3</a>
        </div>
      </form>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
{% if current_user.is_authenticated and current_user.is_subscribed %}
<script>
  let currentAudioUrl = null;
  async function loadVoices(){
    try{
      const response = await fetch('/api/voices');
      const data = await response.json();
      if(data.success){
        const voiceSelect = document.getElementById('voice');
        voiceSelect.innerHTML = '';
        const popularVoices = data.voices.filter(v => v.locale.startsWith('en-') && (v.name.includes('Emma')||v.name.includes('Jenny')||v.name.includes('Guy')||v.name.includes('Ryan')));
        if(popularVoices.length){
          const optgroup = document.createElement('optgroup');
          optgroup.label = 'Popular English Voices';
          popularVoices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.shortName;
            option.textContent = `${voice.localName} (${voice.gender}) - ${voice.locale}`;
            optgroup.appendChild(option);
          });
          voiceSelect.appendChild(optgroup);
        }
        const all = document.createElement('optgroup');
        all.label = 'All Voices';
        data.voices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.shortName;
          option.textContent = `${voice.localName} (${voice.gender}) - ${voice.locale}`;
          all.appendChild(option);
        });
        voiceSelect.appendChild(all);
        voiceSelect.value = 'en-US-EmmaMultilingualNeural';
      }
    }catch(err){
      console.error(err);
      const el = document.getElementById('error');
      el.textContent = 'Failed to load voices. Please refresh.';
      el.classList.add('visible');
    }
  }
  function bindSlider(sliderId, outId, suffix){
    const s = document.getElementById(sliderId), d = document.getElementById(outId);
    s.addEventListener('input', () => {
      const v = parseInt(s.value);
      d.textContent = v === 0 ? 'Normal' : ((v>0?'+':'')+v+suffix);
    });
  }
  bindSlider('rate','rateValue','%');
  bindSlider('volume','volumeValue','%');
  bindSlider('pitch','pitchValue','Hz');

  document.getElementById('ttsForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = document.getElementById('text').value;
    const voice = document.getElementById('voice').value;
    const rate = document.getElementById('rate').value;
    const volume = document.getElementById('volume').value;
    const pitch = document.getElementById('pitch').value;
    document.getElementById('loading').classList.add('visible');
    document.getElementById('error').classList.remove('visible');
    document.getElementById('audioPlayer').style.display = 'none';
    document.getElementById('generateBtn').disabled = true;
    try{
      const res = await fetch('/api/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
        text, voice,
        rate: (rate>=0?'+':'')+rate+'%',
        volume: (volume>=0?'+':'')+volume+'%',
        pitch: (pitch>=0?'+':'')+pitch+'Hz',
      })});
      const data = await res.json();
      if(data.success){
        if(currentAudioUrl){ URL.revokeObjectURL(currentAudioUrl); }
        currentAudioUrl = data.audioUrl;
        const audio = document.getElementById('audioElement');
        audio.src = data.audioUrl;
        const dl = document.getElementById('downloadLink');
        dl.href = data.audioUrl;
        document.getElementById('audioPlayer').style.display = 'block';
        audio.play();
      } else {
        throw new Error(data.error || 'Failed to generate');
      }
    }catch(err){
      const el = document.getElementById('error');
      el.textContent = 'Error: '+ err.message;
      el.classList.add('visible');
    }finally{
      document.getElementById('loading').classList.remove('visible');
      document.getElementById('generateBtn').disabled = false;
    }
  });
  loadVoices();
</script>
{% endif %}
{% endblock %}

