{% extends 'base.html' %}
{% block title %}Cheap TTS ‚Äî Text to Speech Dashboard{% endblock %}
{% block head %}
<style>
  .dashboard-hero {
    background: radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.08), transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(139, 92, 246, 0.08), transparent 50%);
    padding: 60px 0 40px 0;
    text-align: center;
    border-bottom: 1px solid #e5e7eb;
  }
  .dashboard-hero h1 {
    font-size: 42px;
    font-weight: 900;
    margin-bottom: 12px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .dashboard-hero p {
    font-size: 18px;
    color: #6b7280;
  }
  .tts-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 48px 24px;
  }
  .form-card {
    background: white;
    padding: 40px;
    border-radius: 20px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
  }
  .form-section {
    margin-bottom: 32px;
  }
  .form-section:last-of-type {
    margin-bottom: 0;
  }
  .section-title {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: linear-gradient(180deg, #3b82f6, #8b5cf6);
    border-radius: 2px;
  }
  .input-group {
    margin-bottom: 20px;
  }
  .input-group:last-child {
    margin-bottom: 0;
  }
  label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
  }
  textarea, select {
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    background: #f9fafb;
    color: #1f2937;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s;
  }
  textarea:focus, select:focus {
    outline: none;
    border-color: #3b82f6;
    background: white;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }
  textarea {
    min-height: 160px;
    resize: vertical;
    font-family: ui-monospace, SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
    line-height: 1.6;
  }
  select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 16px center;
    padding-right: 40px;
  }
  select option {
    background: white;
    color: #1f2937;
    padding: 8px;
  }
  .controls-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 24px;
  }
  @media (min-width: 768px) {
    .controls-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  .slider-group {
    background: #f9fafb;
    padding: 16px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
  }
  .slider-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
  }
  .slider-value {
    color: #3b82f6;
    font-weight: 700;
  }
  input[type="range"] {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: #e5e7eb;
    outline: none;
    -webkit-appearance: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
  }
  input[type="range"]::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
  }
  .generate-btn {
    width: 100%;
    padding: 18px 24px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    color: white;
    font-weight: 700;
    font-size: 17px;
    background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
    transition: all 0.3s;
    margin-top: 32px;
  }
  .generate-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
  }
  .generate-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }
  .loading {
    display: none;
    text-align: center;
    padding: 24px;
    margin-top: 24px;
    background: #eff6ff;
    border-radius: 12px;
    border: 1px solid #dbeafe;
  }
  .loading.visible {
    display: block;
  }
  .loading p {
    color: #3b82f6;
    font-weight: 600;
    margin: 0;
  }
  .error {
    display: none;
    background: #fee;
    border: 1px solid #fcc;
    padding: 16px;
    border-radius: 12px;
    margin-top: 24px;
    color: #dc2626;
    font-weight: 500;
  }
  .error.visible {
    display: block;
  }
  .audio-player {
    margin-top: 32px;
    padding: 32px;
    border: 2px solid #e5e7eb;
    border-radius: 16px;
    background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
  }
  .audio-player strong {
    display: block;
    font-size: 18px;
    color: #1f2937;
    margin-bottom: 16px;
  }
  .audio-player audio {
    width: 100%;
    margin-bottom: 16px;
    border-radius: 8px;
  }
  .download-btn {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 10px;
    border: 2px solid #3b82f6;
    background: white;
    color: #3b82f6;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
  }
  .download-btn:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-1px);
  }
  .cta {
    display: grid;
    gap: 20px;
    text-align: center;
    max-width: 600px;
    margin: 80px auto;
    padding: 48px 32px;
    background: white;
    border-radius: 20px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
  }
  .cta h3 {
    margin: 0;
    font-size: 32px;
    font-weight: 900;
    color: #1f2937;
  }
  .cta p {
    margin: 0;
    color: #6b7280;
    font-size: 18px;
  }
  .cta .actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin-top: 12px;
    flex-wrap: wrap;
  }
</style>
{% endblock %}

{% block content %}
  {% if not current_user.is_authenticated %}
    <div class="cta">
      <h3>Sign in to start creating audio</h3>
      <p>Create an account and subscribe for $7.99/month</p>
      <div class="actions">
        <a class="btn" href="{{ url_for('login') }}">Sign in</a>
        <a class="btn primary" href="{{ url_for('signup') }}">Sign up</a>
      </div>
    </div>
  {% elif not current_user.is_subscribed %}
    <div class="cta">
      <h3>Subscribe to unlock Text‚Äëto‚ÄëSpeech</h3>
      <p>Unlimited generation. Cancel anytime.</p>
      <div class="actions">
        <a class="btn primary" href="{{ url_for('subscribe') }}">Subscribe $7.99/month</a>
      </div>
    </div>
  {% else %}
    <div class="tts-container">
      <form id="ttsForm">
        <div class="form-card">
          <!-- Text Input Section -->
          <div class="form-section">
            <div class="section-title">Your Text</div>
            <div class="input-group">
              <label for="text">Enter the text you want to convert to speech</label>
              <textarea id="text" placeholder="Type or paste your text here..." required></textarea>
            </div>
          </div>

          <!-- Voice Selection Section -->
          <div class="form-section">
            <div class="section-title">Voice Settings</div>
            <div class="input-group">
              <label for="voice">Choose Voice</label>
              <select id="voice" required>
                <option value="">Loading voices...</option>
              </select>
            </div>
          </div>

          <!-- Audio Adjustments Section -->
          <div class="form-section">
            <div class="section-title">Audio Adjustments</div>
            <div class="controls-grid">
              <div class="slider-group">
                <div class="slider-label">
                  <span>Speed</span>
                  <span class="slider-value" id="rateValue">Normal</span>
                </div>
                <input type="range" id="rate" min="-50" max="50" value="0" step="5" />
              </div>
              <div class="slider-group">
                <div class="slider-label">
                  <span>Volume</span>
                  <span class="slider-value" id="volumeValue">Normal</span>
                </div>
                <input type="range" id="volume" min="-50" max="50" value="0" step="5" />
              </div>
              <div class="slider-group">
                <div class="slider-label">
                  <span>Pitch</span>
                  <span class="slider-value" id="pitchValue">Normal</span>
                </div>
                <input type="range" id="pitch" min="-50" max="50" value="0" step="5" />
              </div>
            </div>
          </div>

          <button type="submit" class="generate-btn" id="generateBtn">üéôÔ∏è Generate Speech</button>
        </div>

        <div class="loading" id="loading">
          <p>‚è≥ Generating your speech...</p>
        </div>
        <div class="error" id="error"></div>
        <div class="audio-player" id="audioPlayer" style="display:none">
          <strong>‚ú® Your audio is ready!</strong>
          <audio id="audioElement" controls></audio>
          <a id="downloadLink" class="download-btn" download="speech.mp3">‚¨áÔ∏è Download MP3</a>
        </div>
      </form>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
{% if current_user.is_authenticated and current_user.is_subscribed %}
<script>
  let currentAudioUrl = null;
  async function loadVoices(){
    try{
      const response = await fetch('/api/voices');
      const data = await response.json();
      if(data.success){
        const voiceSelect = document.getElementById('voice');
        voiceSelect.innerHTML = '';
        const popularVoices = data.voices.filter(v => v.locale.startsWith('en-') && (v.name.includes('Emma')||v.name.includes('Jenny')||v.name.includes('Guy')||v.name.includes('Ryan')));
        if(popularVoices.length){
          const optgroup = document.createElement('optgroup');
          optgroup.label = 'Popular English Voices';
          popularVoices.forEach(voice => {
            const option = document.createElement('option');
            option.value = voice.shortName;
            option.textContent = `${voice.localName} (${voice.gender}) - ${voice.locale}`;
            optgroup.appendChild(option);
          });
          voiceSelect.appendChild(optgroup);
        }
        const all = document.createElement('optgroup');
        all.label = 'All Voices';
        data.voices.forEach(voice => {
          const option = document.createElement('option');
          option.value = voice.shortName;
          option.textContent = `${voice.localName} (${voice.gender}) - ${voice.locale}`;
          all.appendChild(option);
        });
        voiceSelect.appendChild(all);
        voiceSelect.value = 'en-US-EmmaMultilingualNeural';
      }
    }catch(err){
      console.error(err);
      const el = document.getElementById('error');
      el.textContent = 'Failed to load voices. Please refresh.';
      el.classList.add('visible');
    }
  }
  function bindSlider(sliderId, outId, suffix){
    const s = document.getElementById(sliderId), d = document.getElementById(outId);
    s.addEventListener('input', () => {
      const v = parseInt(s.value);
      d.textContent = v === 0 ? 'Normal' : ((v>0?'+':'')+v+suffix);
    });
  }
  bindSlider('rate','rateValue','%');
  bindSlider('volume','volumeValue','%');
  bindSlider('pitch','pitchValue','Hz');

  document.getElementById('ttsForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const text = document.getElementById('text').value;
    const voice = document.getElementById('voice').value;
    const rate = document.getElementById('rate').value;
    const volume = document.getElementById('volume').value;
    const pitch = document.getElementById('pitch').value;
    document.getElementById('loading').classList.add('visible');
    document.getElementById('error').classList.remove('visible');
    document.getElementById('audioPlayer').style.display = 'none';
    document.getElementById('generateBtn').disabled = true;
    try{
      const res = await fetch('/api/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({
        text, voice,
        rate: (rate>=0?'+':'')+rate+'%',
        volume: (volume>=0?'+':'')+volume+'%',
        pitch: (pitch>=0?'+':'')+pitch+'Hz',
      })});
      const data = await res.json();
      if(data.success){
        if(currentAudioUrl){ URL.revokeObjectURL(currentAudioUrl); }
        currentAudioUrl = data.audioUrl;
        const audio = document.getElementById('audioElement');
        audio.src = data.audioUrl;
        const dl = document.getElementById('downloadLink');
        dl.href = data.audioUrl;
        document.getElementById('audioPlayer').style.display = 'block';
        audio.play();
      } else {
        throw new Error(data.error || 'Failed to generate');
      }
    }catch(err){
      const el = document.getElementById('error');
      el.textContent = 'Error: '+ err.message;
      el.classList.add('visible');
    }finally{
      document.getElementById('loading').classList.remove('visible');
      document.getElementById('generateBtn').disabled = false;
    }
  });
  loadVoices();
</script>
{% endif %}

<div style="text-align: center; margin-top: 60px; padding: 20px; color: #9ca3af; font-size: 14px;">
  Need help? Contact us at <a href="mailto:support@cheaptts.com" style="color: #7c3aed; text-decoration: none;">support@cheaptts.com</a>
</div>
{% endblock %}

